name: pynsource
version: git
summary: 'Pynsource - reverse engineer Python source code into UML'
description: |
      UML tool for Python. Reverse engineer Python source code into UML.

grade: stable # devel # must be 'stable' to release into candidate/stable channels
confinement: devmode # strict # use 'strict' once you have the right plugs and slots
base: core22
architectures:
  - build-on: [amd64]

apps:
  # You can also run with /snap/bin/pynsource. (hit TAB to autocomplete)
  pynsource:
    command: bin/pynsource
    plugs:
      - desktop
      - desktop-legacy
      - x11
      - pulseaudio
      - home
      - gsettings
      - network
      - network-bind
      - removable-media
    desktop: usr/share/applications/pynsource.desktop
    extensions:
      # HINT: Adds plugs and changes environment variables when building and running
      - gnome
  pynsource-cli:
    command: bin/pynsource-cli
    plugs:
      - home
      - network
      - network-bind
      - removable-media
  python-version:
    command: bin/python3
    plugs:
      - home
      - network
      - network-bind
      - removable-media

environment:
  # WORKAROUND: Add python modules in Snap to search path
  PYTHONPATH: ${SNAP}/lib/python3.10/site-packages:${SNAP}/usr/lib/python3/dist-packages

parts:
  copy-stuff:
    plugin: dump
    source: src/media
    organize:
      "*": lib/python3.10/site-packages/media/

  # To get the HelpWindow.html and the help-images folder into the snap
  copy-dialogs:
    plugin: dump
    source: src/dialogs/
    organize:
      "*": lib/python3.10/site-packages/dialogs/

  build-the-python-stuff-please:
    plugin: python
    source: .

    build-environment:
      # WORKAROUND: The python plugin is broken with gnome extension
      - PATH: ${CRAFT_PART_INSTALL}/bin:${PATH}
      - PYTHONPATH: ""
     
    stage-packages:
      - python3-requests
      - python3-serial
      - python3-six
      - python3-suds
      - python3-future
      - python3-yattag
      - python3-wxgtk4.0
    stage:
      # WORKAROUND: Skip venv from python plugin
      - -bin/activate
      - -bin/activate.csh
      - -bin/activate.fish
      - -bin/Activate.ps1
      - -bin/python
      - -bin/python3
      - -bin/python3.10
      - -bin/pip
      - -bin/pip3
      - -bin/pip3.10
      - -pyvenv.cfg      
    python-requirements:
      - /root/project/.requirement-extras/requirements-linux-22.txt
    organize:
      usr/lib/$CRAFT_ARCH_TRIPLET/pulseaudio/libpulsecommon-15.99.so: usr/lib/$CRAFT_ARCH_TRIPLET/libpulsecommon-15.99.so
    # override-build: |
    #   install -Dm644 "snap/gui/pynsource.desktop" -t "$CRAFT_PART_INSTALL/usr/share/applications/"
    #   craftctl default      